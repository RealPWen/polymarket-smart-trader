<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>è·Ÿå•ä»ªè¡¨ç›˜ - Polymarket Trader</title>
    <!-- å¼•å…¥ Plotly for æ›²çº¿ -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        :root {
            --bg-dark: #121212;
            --surface: #1e1e1e;
            --panel-bg: #252525;
            --primary: #007bff;
            --success: #00c853;
            --danger: #d50000;
            --text: #e0e0e0;
            --border: #333;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--surface);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .status-badge {
            background: rgba(0, 200, 83, 0.2);
            color: var(--success);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--success);
        }

        /* ä¸‰åˆ—å¸ƒå±€ */
        .dashboard-container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        /* å·¦å³åˆ—å®½å›ºå®šï¼Œä¸­é—´è‡ªé€‚åº” */
        .col-left,
        .col-right {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .col-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1;
            /* è®©é¢æ¿å¡«æ»¡åˆ—çš„é«˜åº¦ */
        }

        .panel-short {
            flex: 0 0 auto;
            /* é«˜åº¦è‡ªé€‚åº”å†…å®¹ */
        }

        .panel-header {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }

        .panel-content {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }

        /* è®¢å•åˆ—è¡¨ */
        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #333;
            font-size: 12px;
        }

        .trade-item:last-child {
            border-bottom: none;
        }

        .tag-buy {
            color: var(--success);
            font-weight: bold;
        }

        .tag-sell {
            color: var(--danger);
            font-weight: bold;
        }

        .trade-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .trade-meta {
            color: #888;
            font-size: 11px;
        }

        /* ä½™é¢å±•ç¤º */
        .balance-box {
            text-align: center;
            padding: 20px;
        }

        .balance-value {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
        }

        .balance-label {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        .addr-tag {
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            color: #aaa;
            margin-top: 10px;
            display: inline-block;
        }

        /* å¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #444;
            transition: .3s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(14px);
        }

        /* NEW æ ‡ç­¾æ ·å¼ */
        .badge-new {
            background: var(--success);
            color: #000;
            font-size: 9px;
            font-weight: 800;
            padding: 1px 4px;
            border-radius: 3px;
            margin-right: 6px;
            text-transform: uppercase;
            animation: blink 1.5s infinite;
            vertical-align: middle;
            display: inline-block;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }

        /* å¢é‡è¡Œé«˜äº®åŠ¨ç”» */
        @keyframes highlight-new {
            from {
                background-color: rgba(0, 200, 83, 0.1);
            }

            to {
                background-color: transparent;
            }
        }

        .item-new-entry {
            animation: highlight-new 5s ease-out forwards;
        }
    </style>
</head>

<body>

    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <h3 style="margin:0;">Polymarket è·Ÿå•ç›‘æ§å°</h3>
            <div class="status-badge"><span class="dot"></span> ç³»ç»Ÿè¿è¡Œä¸­</div>

            <!-- æ–°å¢ï¼šç­–ç•¥ä¿¡æ¯å±•ç¤º -->
            <div id="strategy-info"
                style="margin-left: 20px; padding-left: 20px; border-left: 1px solid #444; display: flex; gap: 20px; align-items: center;">
                <div style="display: flex; flex-direction: column;">
                    <span style="font-size: 10px; color: #888; text-transform: uppercase;">å½“å‰ç­–ç•¥ <span
                            onclick="openStrategyEdit()" style="cursor: pointer; color: var(--primary);">âœ
                            ç¼–è¾‘</span></span>
                    <span id="display-strategy"
                        style="font-size: 13px; color: var(--primary); font-weight: bold;">--</span>
                </div>
                <div style="display: flex; flex-direction: column;">
                    <span style="font-size: 10px; color: #888; text-transform: uppercase;">æ‰§è¡Œå‚æ•°</span>
                    <span id="display-param" style="font-size: 13px; color: #fff; font-family: monospace;">--</span>
                </div>
                <div style="display: flex; flex-direction: column;">
                    <span style="font-size: 10px; color: #888; text-transform: uppercase;">è®¢å•ç±»å‹</span>
                    <span id="display-type" style="font-size: 13px; color: #fff;">--</span>
                </div>
            </div>
        </div>
        <div style="font-size: 12px; color: #888;">
            æ­£åœ¨ç›‘æ§: <span id="target-addr" style="color: #fff; font-family: monospace;">...</span>
            <span onclick="openAddressEdit()" style="cursor: pointer; color: var(--primary); margin-left: 8px;">âœ
                ç®¡ç†</span>
        </div>
    </div>

    <div class="dashboard-container">

        <!-- å·¦ä¾§: æˆ‘çš„è´¦æˆ·ä¿¡æ¯ -->
        <div class="col-left">
            <div class="panel panel-short">
                <div class="panel-header">æˆ‘çš„èµ„é‡‘è´¦æˆ· (USDC)</div>
                <div class="panel-content balance-box">
                    <a href="https://polymarket.com/portfolio" target="_blank" style="text-decoration: none;">
                        <div class="balance-value" id="my-balance" style="cursor: pointer; transition: opacity 0.2s;"
                            onmouseover="this.style.opacity=0.8" onmouseout="this.style.opacity=1">Loading...</div>
                    </a>
                    <div class="balance-label">å¯ç”¨ä½™é¢</div>
                    <div class="addr-tag" id="my-address">Loading...</div>
                </div>
            </div>

            <div class="panel" style="flex: 1;">
                <div class="panel-header">æˆ‘çš„ç°æœ‰æŒä»“ (My Positions)</div>
                <div class="panel-content" id="my-positions-list">
                    <div style="text-align: center; color: #666; padding: 20px;">æš‚æ— æŒä»“</div>
                </div>
            </div>

            <div class="panel" style="flex: 1;">
                <div class="panel-header">æˆ‘çš„æˆäº¤å†å² (My Executions)</div>
                <div class="panel-content" id="my-trades-list">
                    <!-- JS åŠ¨æ€å¡«å…… -->
                    <div style="text-align: center; color: #666; padding: 20px;">æš‚æ— è·Ÿå•è®°å½•</div>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´: æ”¶ç›Šæ›²çº¿å¯¹æ¯” -->
        <div class="col-center" style="display: flex; flex-direction: column;">
            <!-- æˆ‘çš„æ€»æ”¶ç›Šæ›²çº¿ (å§‹ç»ˆå›ºå®šåœ¨é¡¶éƒ¨) -->
            <div class="panel" style="flex: 2; min-height: 300px;">
                <div class="panel-header">
                    <span>æˆ‘çš„è´¦æˆ·ç´¯è®¡æ€»æ”¶ç›Š (Overall PnL)</span>
                    <span id="my-pnl-total" style="font-size: 12px; color: var(--success);">--</span>
                </div>
                <div class="panel-content" style="padding: 0; overflow: hidden; display: flex;">
                    <div id="my-pnl-chart" style="flex: 1; width: 100%;"></div>
                </div>
            </div>

            <!-- ç›®æ ‡å¯¹æ¯”å®¹å™¨ï¼šJS å°†åŠ¨æ€å‘æ­¤å®¹å™¨æ·»åŠ å„ä¸ªäº¤æ˜“å‘˜çš„å›¾è¡¨ -->
            <div id="target-charts-container"
                style="flex: 3; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; padding-bottom: 20px;">
                <!-- JS åŠ¨æ€å¡«å…… -->
            </div>
        </div>

        <!-- å³ä¾§: ç›‘æµ‹ç›®æ ‡æµ -->
        <div class="col-right">
            <div class="panel">
                <div class="panel-header">
                    <span>ç›®æ ‡äº¤æ˜“å‘˜è®¢å•æµ (Target Stream)</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 10px; font-weight: normal; color: #888;">å£°éŸ³æé†’</span>
                        <label class="switch">
                            <input type="checkbox" id="sound-toggle" onchange="toggleSoundPref()">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div class="panel-content" id="target-trades-list">
                    <!-- JS åŠ¨æ€å¡«å…… -->
                </div>
            </div>
        </div>
    </div>

    <!-- ç­–ç•¥ç¼–è¾‘å¼¹çª— -->
    <div id="strategy-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; justify-content: center; align-items: center;">
        <div
            style="background: var(--surface); padding: 30px; border-radius: 12px; width: 400px; border: 1px solid var(--border);">
            <h3 style="margin-top: 0; margin-bottom: 20px;">ä¿®æ”¹è·Ÿå•ç­–ç•¥</h3>

            <label style="display: block; margin-bottom: 10px; font-size: 12px; color: #aaa;">é€‰æ‹©æ¨¡å¼</label>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="edit-mode-1" class="edit-mode-btn" data-mode="1" onclick="selectEditMode(1)"
                    style="flex: 1; padding: 10px; background: #333; border: 1px solid transparent; color: #fff; cursor: pointer; border-radius: 4px;">é‡‘é¢æ¯”ä¾‹</button>
                <button id="edit-mode-2" class="edit-mode-btn" data-mode="2" onclick="selectEditMode(2)"
                    style="flex: 1; padding: 10px; background: #333; border: 1px solid transparent; color: #fff; cursor: pointer; border-radius: 4px;">ä»“ä½å æ¯”</button>
                <button id="edit-mode-3" class="edit-mode-btn" data-mode="3" onclick="selectEditMode(3)"
                    style="flex: 1; padding: 10px; background: #333; border: 1px solid transparent; color: #fff; cursor: pointer; border-radius: 4px;">æ’å®šé‡‘é¢</button>
            </div>

            <label id="edit-param-label" style="display: block; margin-bottom: 8px; font-weight: bold;">å‚æ•°æ•°å€¼</label>
            <input type="number" id="edit-param"
                style="width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; margin-bottom: 25px;">

            <div style="display: flex; gap: 10px;">
                <button onclick="closeStrategyEdit()"
                    style="flex: 1; padding: 12px; background: transparent; border: 1px solid #555; color: #fff; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                <button id="save-strat-btn" onclick="saveStrategy()"
                    style="flex: 1; padding: 12px; background: var(--primary); border: none; color: #fff; border-radius: 4px; cursor: pointer;">ç¡®è®¤ä¿®æ”¹</button>
            </div>

            <style>
                .edit-mode-btn.active {
                    background: rgba(0, 123, 255, 0.2) !important;
                    border-color: var(--primary) !important;
                    color: var(--primary) !important;
                }
            </style>
        </div>
    </div>

    <!-- åœ°å€ç®¡ç†å¼¹çª— -->
    <div id="address-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; justify-content: center; align-items: center;">
        <div
            style="background: var(--surface); padding: 30px; border-radius: 12px; width: 500px; border: 1px solid var(--border);">
            <h3 style="margin-top: 0; margin-bottom: 20px;">ç®¡ç†ç›‘æ§ç›®æ ‡</h3>

            <div id="addr-list-container"
                style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                <!-- JS åŠ¨æ€å¡«å…… -->
            </div>

            <button onclick="addAddressInput()"
                style="width: 100%; padding: 8px; border: 1px dashed #555; background: rgba(255,255,255,0.05); color: #aaa; cursor: pointer; margin-bottom: 25px;">+
                æ·»åŠ æ–°åœ°å€</button>

            <div style="display: flex; gap: 10px;">
                <button onclick="closeAddressEdit()"
                    style="flex: 1; padding: 12px; background: transparent; border: 1px solid #555; color: #fff; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                <button id="save-addr-btn" onclick="saveAddresses()"
                    style="flex: 1; padding: 12px; background: var(--primary); border: none; color: #fff; border-radius: 4px; cursor: pointer;">ä¿å­˜å¹¶é‡å¯</button>
            </div>
        </div>
    </div>

    <!-- å†…ç½®æç¤ºéŸ³ (Base64) -->
    <audio id="notif-sound"
        src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YTdvT19"></audio>
    <script>
        const dingUrl = "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3";
        document.getElementById('notif-sound').src = dingUrl;

        // URL å‚æ•°è§£æ
        const params = new URLSearchParams(window.location.search);
        let addressList = (params.get('address') || "").split(',').filter(a => a.startsWith('0x'));
        const mode = params.get('mode');
        const param = params.get('param');

        // --- åœ°å€ç®¡ç†é€»è¾‘ ---
        function openAddressEdit() {
            const modal = document.getElementById('address-modal');
            const container = document.getElementById('addr-list-container');
            container.innerHTML = ''; // æ¸…ç©º

            addressList.forEach(addr => addAddressInput(addr));
            if (addressList.length === 0) addAddressInput(); // è‡³å°‘æ˜¾ç¤ºä¸€ä¸ª

            modal.style.display = 'flex';
        }

        function closeAddressEdit() {
            document.getElementById('address-modal').style.display = 'none';
        }

        function addAddressInput(value = "") {
            const div = document.createElement('div');
            div.style.cssText = "display: flex; gap: 8px;";
            div.innerHTML = `
                <input type="text" class="addr-input" value="${value}" placeholder="0x..." style="flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px;">
                <button onclick="this.parentElement.remove()" style="padding: 0 15px; background: #333; color: #ff1744; border: 1px solid #444; border-radius: 4px; cursor: pointer;">âœ•</button>
            `;
            document.getElementById('addr-list-container').appendChild(div);
        }

        async function saveAddresses() {
            const inputs = document.querySelectorAll('.addr-input');
            const newAddresses = Array.from(inputs).map(i => i.value.trim()).filter(a => a.startsWith('0x'));

            if (newAddresses.length === 0) {
                alert("è¯·è‡³å°‘ä¿ç•™ä¸€ä¸ªæœ‰æ•ˆåœ°å€");
                return;
            }

            const btn = document.getElementById('save-addr-btn');
            btn.innerText = "æ­£åœ¨é‡å¯æœåŠ¡...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/copy-trade/update-clients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ addresses: newAddresses })
                });
                const data = await res.json();

                if (data.status === 'restarted') {
                    alert("æœåŠ¡å·²é‡å¯ï¼é¡µé¢å³å°†åˆ·æ–°...");
                    // æ„é€ æ–°çš„ URL å¹¶åˆ·æ–°
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set('address', newAddresses.join(','));
                    window.location.href = newUrl.toString();
                } else {
                    alert("æ›´æ–°å¤±è´¥: " + data.error);
                    btn.innerText = "ä¿å­˜å¹¶é‡å¯";
                    btn.disabled = false;
                }
            } catch (e) {
                alert("è¯·æ±‚é”™è¯¯: " + e);
                btn.innerText = "ä¿å­˜å¹¶é‡å¯";
                btn.disabled = false;
            }
        }

        const orderType = params.get('order_type');
        let myWalletAddress = null;

        // æ›´æ–°é¡¶éƒ¨ç­–ç•¥å±•ç¤º
        if (mode) {
            const modeNames = { '1': 'é‡‘é¢æ¯”ä¾‹ (Ratio)', '2': 'ä»“ä½å æ¯” (Portfolio)', '3': 'æ’å®šé‡‘é¢ (Constant)' };
            document.getElementById('display-strategy').innerText = modeNames[mode] || 'è‡ªå®šä¹‰';
            let pText = '--';
            if (mode === '1') pText = 'x' + param;
            if (mode === '2') pText = 'è‡ªåŠ¨è®¡ç®—';
            if (mode === '3') pText = '$' + param;
            document.getElementById('display-param').innerText = pText;
        }
        if (orderType) document.getElementById('display-type').innerText = orderType;
        document.getElementById('target-addr').innerText = addressList.length > 1 ? `${addressList.length} ä¸ªåœ°å€` : addressList[0];

        // --- åŠ¨æ€ç”Ÿæˆç›®æ ‡æ›²çº¿ UI ---
        const targetContainer = document.getElementById('target-charts-container');
        addressList.forEach((addr, index) => {
            const html = `
                <div class="panel" style="flex: none; height: 250px;">
                    <div class="panel-header">
                        <span>è·Ÿè¸ª: ${addr.slice(0, 8)}...${addr.slice(-6)}</span>
                        <span id="total-pnl-${addr}" style="font-size: 12px; color: var(--primary);">--</span>
                    </div>
                    <div class="panel-content" style="padding: 0; display: flex;">
                        <div id="chart-${addr}" style="flex: 1; width: 100%;"></div>
                    </div>
                </div>
            `;
            targetContainer.insertAdjacentHTML('beforeend', html);
        });

        // --- çŠ¶æ€ä¸è¿½è¸ª ---
        const lastState = { balance: "", positions: "", executions: "", targetStream: "" };
        const knownHashes = { executions: new Set(), targetStream: new Set() };
        let initialLoadDone = { executions: false, targetStream: false };

        // å®šæ—¶åˆ·æ–°
        setInterval(() => {
            fetchMyBalance();
            fetchTargetStreamAggregate();
            // updateCharts(); // ç§»é™¤æ— è„‘è½®è¯¢ï¼Œæ”¹ä¸ºæŒ‰éœ€è§¦å‘
        }, 5000);

        function playNotification() {
            const audio = document.getElementById('notif-sound');
            if (audio) { audio.currentTime = 0; audio.play().catch(e => { }); }
        }

        async function fetchMyBalance() {
            try {
                const res = await fetch('/api/my-balance');
                const data = await res.json();
                const str = JSON.stringify(data);

                // ä¼˜åŒ–ï¼šåªæœ‰å½“ä½™é¢å˜åŒ–ï¼ˆæˆ–åˆå§‹åŒ–ï¼‰æ—¶ï¼Œæ‰å»æŸ¥è¯¢æŒä»“å’Œè®¢å•æµ
                if (str === lastState.balance) return;

                console.log("ğŸ’° ä½™é¢å˜åŒ–æ£€æµ‹: ", lastState.balance, "->", str);
                lastState.balance = str;

                if (data.cash !== undefined) {
                    document.getElementById('my-balance').innerText = '$' + data.cash.toFixed(2);
                    document.getElementById('my-address').innerText = data.address.slice(0, 6) + '...' + data.address.slice(-4);

                    const isFirst = (myWalletAddress === null);
                    myWalletAddress = data.address;

                    // è§¦å‘çº§è”æ›´æ–°
                    fetchMyPositions();
                    fetchMyExecutions();
                    // æ›´æ–°æˆ‘çš„ PnL æ›²çº¿
                    fetchAnalysis(myWalletAddress, 'my-pnl-chart', 'my-pnl-total', '#00c853');

                    if (isFirst) {
                        // é¦–æ¬¡åŠ è½½æ—¶ï¼Œä¹Ÿå¼ºåˆ¶åˆ·æ–°ä¸€ä¸‹ç›®æ ‡å›¾è¡¨
                        updateTargetCharts();
                    }
                }
            } catch (e) { }
        }

        function updateTargetCharts() {
            addressList.forEach(addr => {
                fetchAnalysis(addr, `chart-${addr}`, `total-pnl-${addr}`, '#007bff');
            });
        }

        async function updateCharts() {
            // ä¿ç•™æ­¤å‡½æ•°ç”¨äº resize äº‹ä»¶ï¼Œä½†ä¸ç”¨äºè½®è¯¢
            if (myWalletAddress) fetchAnalysis(myWalletAddress, 'my-pnl-chart', 'my-pnl-total', '#00c853');
            updateTargetCharts();
        }

        async function fetchAnalysis(addr, chartId, totalId, color) {
            try {
                const res = await fetch(`/api/analysis/${addr}`);
                const data = await res.json();
                if (data.pnl_history && data.pnl_history.length > 0) {
                    const x = data.pnl_history.map(d => d.date);
                    const y = data.pnl_history.map(d => d.cumulative_pnl);
                    const lastPnl = y[y.length - 1];
                    const el = document.getElementById(totalId);
                    if (el) {
                        el.innerText = (lastPnl >= 0 ? '+' : '') + '$' + lastPnl.toFixed(2);
                        el.style.color = lastPnl >= 0 ? '#00c853' : '#ff1744';
                    }
                    Plotly.react(chartId, [{
                        x: x, y: y, type: 'scatter', mode: 'lines+markers',
                        marker: { size: 4, opacity: 0.5 },
                        fill: 'tozeroy',
                        line: { color: color, width: 3, shape: 'spline' },
                        fillcolor: color === '#00c853' ? 'rgba(0,200,83,0.1)' : 'rgba(0,123,255,0.1)'
                    }], {
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: '#888', size: 10 },
                        margin: { t: 5, r: 25, l: 35, b: 30 },
                        xaxis: { gridcolor: '#222', showgrid: true, zeroline: false },
                        yaxis: { gridcolor: '#222', showgrid: true, zeroline: true, zerolinecolor: '#444', tickprefix: '$' },
                        autosize: true
                    }, { responsive: true, displayModeBar: false });
                }
            } catch (e) { }
        }

        async function fetchTargetStreamAggregate() {
            try {
                // å¹¶å‘è¯·æ±‚æ‰€æœ‰åœ°å€çš„æµ
                const results = await Promise.all(addressList.map(addr => fetch(`/stream/${addr}`).then(r => r.json())));
                // åˆå¹¶å¹¶å¹³é“º
                let allTrades = [];
                results.forEach((list, i) => {
                    const traderTag = addressList[i].slice(0, 6);
                    list.forEach(t => {
                        t._trader = traderTag; // æ ‡è®°æ¥æº
                        allTrades.push(t);
                    });
                });

                // æŒ‰æ—¥æœŸæ’åº (æœ€æ–°åœ¨å‰)
                allTrades.sort((a, b) => new Date(b.date_str) - new Date(a.date_str));

                const dataStr = JSON.stringify(allTrades);
                if (initialLoadDone.targetStream && dataStr !== lastState.targetStream) {
                    if (localStorage.getItem('enable_sound') === 'true') playNotification();

                    // ç›®æ ‡æµæœ‰æ›´æ–° -> æ›´æ–°ç›®æ ‡å›¾è¡¨
                    console.log("ğŸŒŠ ç›®æ ‡æµæ›´æ–°ï¼Œåˆ·æ–°å›¾è¡¨...");
                    updateTargetCharts();
                }

                if (dataStr === lastState.targetStream) return;
                lastState.targetStream = dataStr;

                const container = document.getElementById('target-trades-list');
                container.innerHTML = allTrades.map(t => {
                    const isNew = initialLoadDone.targetStream && !knownHashes.targetStream.has(t.transactionHash);
                    knownHashes.targetStream.add(t.transactionHash);
                    return `
                    <div class="trade-item ${isNew ? 'item-new-entry' : ''}">
                        <div class="trade-info">
                            <span style="color: #fff; font-size: 11px;">
                                <span style="color:var(--primary); font-weight:bold;">[${t._trader}]</span> 
                                ${isNew ? '<span class="badge-new">NEW</span>' : ''}
                                ${t.title.slice(0, 20)}...
                            </span>
                            <div style="margin-top:2px;">
                                <span class="${t.side === 'BUY' ? 'tag-buy' : 'tag-sell'}">${t.side}</span>
                                <span>${t.outcome}</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <span style="display:block; font-weight:bold;">$${(t.size * t.price).toFixed(2)}</span>
                            <span class="trade-meta">${t.date_str.split(' ')[1]}</span>
                        </div>
                    </div>`;
                }).join('');
                initialLoadDone.targetStream = true;
            } catch (e) { }
        }

        async function fetchMyExecutions() {
            try {
                const res = await fetch('/api/my-executions');
                const data = await res.json();
                if (JSON.stringify(data) === lastState.executions) return;
                lastState.executions = JSON.stringify(data);
                const container = document.getElementById('my-trades-list');
                container.innerHTML = data.map(t => {
                    const id = t.timestamp + t.side + t.size;
                    const isNew = initialLoadDone.executions && !knownHashes.executions.has(id);
                    knownHashes.executions.add(id);
                    return `
                    <div class="trade-item ${isNew ? 'item-new-entry' : ''}">
                        <div class="trade-info">
                            <span style="color: #fff; font-size: 11px; font-weight: bold;">
                                ${isNew ? '<span class="badge-new">NEW</span>' : ''}
                                ${t.market_title.slice(0, 25)}
                            </span>
                            <div><span class="${t.side === 'BUY' ? 'tag-buy' : 'tag-sell'}">${t.side}</span> ${t.size} è‚¡</div>
                        </div>
                        <div style="text-align: right;">
                            <span style="display:block; font-weight:bold;">$${t.my_target_amount.toFixed(2)}</span>
                            <span class="trade-meta">${t.date_str.split(' ')[1]}</span>
                        </div>
                    </div>`;
                }).join('');
                initialLoadDone.executions = true;
            } catch (e) { }
        }

        async function fetchMyPositions() {
            try {
                const res = await fetch('/api/my-positions');
                const data = await res.json();
                const dataStr = JSON.stringify(data);

                if (dataStr === lastState.positions) return;
                lastState.positions = dataStr;

                const container = document.getElementById('my-positions-list');
                if (!data || data.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— æŒä»“</div>';
                    return;
                }
                container.innerHTML = data.map(p => {
                    const slug = p.eventSlug || p.slug || p.marketSlug;
                    const title = (p.title || 'Unknown').slice(0, 40);
                    const titleHtml = slug
                        ? `<a href="https://polymarket.com/event/${slug}" target="_blank" style="color: #fff; font-weight: bold; font-size: 11px; text-decoration: underline; text-decoration-color: #555;">${title}</a>`
                        : `<span style="color: #fff; font-weight: bold; font-size: 11px;">${title}</span>`;

                    return `
                    <div class="trade-item">
                        <div class="trade-info">
                            ${titleHtml}
                            <span style="color: #aaa; font-size: 10px;">${p.outcome || 'N/A'}</span>
                        </div>
                        <div style="text-align: right;">
                            <span style="display:block; font-weight:bold; color: #fff;">${parseFloat(p.size).toFixed(2)} è‚¡</span>
                        </div>
                    </div>
                `}).join('');
            } catch (e) { console.error(e); }
        }
        function toggleSoundPref() {
            const checked = document.getElementById('sound-toggle').checked;
            localStorage.setItem('enable_sound', checked ? 'true' : 'false');
            if (checked) playNotification();
        }

        // --- ç­–ç•¥ç¼–è¾‘ç›¸å…³ ---
        let currentStrategy = { mode: 1, param: 1.0 }; // é»˜è®¤

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– (ä» URL è¿™é‡Œå…¶å®æ‹¿ä¸åˆ°æœ€æ–°çš„ï¼Œå¦‚æœæœ‰æ›´æŒä¹…çš„å­˜å‚¨æ›´å¥½ï¼Œè¿™é‡Œå…ˆç”¨ URL å…œåº•)
        if (mode) currentStrategy.mode = parseInt(mode);
        if (param) currentStrategy.param = parseFloat(param);

        function openStrategyEdit() {
            const modal = document.getElementById('strategy-modal');
            modal.style.display = 'flex';

            // é€‰ä¸­å½“å‰æ¨¡å¼
            document.getElementById(`edit-mode-${currentStrategy.mode}`).click();
            document.getElementById('edit-param').value = currentStrategy.param;
        }

        function closeStrategyEdit() {
            document.getElementById('strategy-modal').style.display = 'none';
        }

        function selectEditMode(m) {
            document.querySelectorAll('.edit-mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`edit-mode-${m}`).classList.add('active');

            const label = document.getElementById('edit-param-label');
            if (m === 1) label.innerText = "è·Ÿå•æ¯”ä¾‹ (0.1 - 10.0)";
            if (m === 2) label.innerText = "ä»“ä½å æ¯” (0.1 = 10%) [å•äººæ¨¡å¼]";
            if (m === 3) label.innerText = "å•ç¬”å›ºå®šé‡‘é¢ (USD)";
        }

        async function saveStrategy() {
            const modeBtn = document.querySelector('.edit-mode-btn.active');
            const newMode = parseInt(modeBtn.dataset.mode);
            const newParam = parseFloat(document.getElementById('edit-param').value);

            if (isNaN(newParam) || newParam <= 0) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å‚æ•°æ•°å€¼");
                return;
            }

            const payload = {
                mode: newMode,
                param: newParam
            };

            const btn = document.getElementById('save-strat-btn');
            btn.innerText = "ä¿å­˜ä¸­...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/copy-trade/update-strategy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.status === 'updated') {
                    // æ›´æ–°æœ¬åœ°çŠ¶æ€å’Œ UI
                    currentStrategy = payload;

                    const modeNames = { '1': 'é‡‘é¢æ¯”ä¾‹ (Ratio)', '2': 'ä»“ä½å æ¯” (Portfolio)', '3': 'æ’å®šé‡‘é¢ (Constant)' };
                    document.getElementById('display-strategy').innerText = modeNames[newMode] || 'è‡ªå®šä¹‰';

                    let pText = '--';
                    if (newMode === 1) pText = 'x' + newParam;
                    if (newMode === 2) pText = (newParam * 100).toFixed(0) + '%';
                    if (newMode === 3) pText = '$' + newParam;
                    document.getElementById('display-param').innerText = pText;

                    closeStrategyEdit();
                    alert("ç­–ç•¥æ›´æ–°æˆåŠŸï¼ä¸‹ä¸€æ¬¡è·Ÿå•å°†åº”ç”¨æ–°å‚æ•°ã€‚");
                } else {
                    alert("æ›´æ–°å¤±è´¥: " + data.error);
                }
            } catch (e) {
                alert("è¯·æ±‚é”™è¯¯: " + e);
            } finally {
                btn.innerText = "ç¡®è®¤ä¿®æ”¹";
                btn.disabled = false;
            }
        }


        // --- æ–°å¢ï¼šå“åº”å¼å¸ƒå±€é€‚é… ---
        window.addEventListener('resize', () => {
            updateCharts();
        });

        fetchMyBalance().then(() => {
            const saved = localStorage.getItem('enable_sound');
            if (saved === 'true') document.getElementById('sound-toggle').checked = true;
            // åˆå§‹ä¹Ÿæ‹‰ä¸€ä¸‹ï¼Œé˜²æ­¢ Balance åˆšå¼€å§‹ä¸€æ ·å¯¼è‡´ä¸è§¦å‘
            fetchMyPositions();
            fetchMyExecutions();
            fetchTargetStreamAggregate();
        });
    </script>
</body>

</html>